<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Mission Autonomy Map</title>
    <style>
        #map {
            height: 65vh;
            width: 70%;
            position: absolute;
            right: 0;
            top: 70px;
            border: 2px solid #d1d5db;
        }
        #sidebar {
            width: 30%;
            height: 100vh;
            position: absolute;
            left: 0;
            top: 0;
            background-color: #1E293B;
            color: white;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }
        #summary {
            background-color: #374151;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        .controls {
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="sidebar">
        <h1 class="text-3xl font-bold mb-4">Mission Autonomy Dashboard</h1>
        <div id="controls" class="controls">
            <label for="mission-select" class="font-semibold text-sm block mb-2">Select Mission:</label>
            <select id="mission-select" class="p-2 mb-4 w-full border border-gray-400 rounded text-gray-800">
                <!-- Mission options populated dynamically -->
            </select>
            <button onclick="loadMission()" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold py-2 px-4 mb-2 w-full rounded">Load Mission</button>
            <button onclick="pauseTelemetry()" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 mb-2 w-full rounded">Pause</button>
            <button onclick="resumeTelemetry()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 w-full rounded">Resume</button>
            <button id="saveGeofenceBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 w-full rounded mt-4">Save Geofence</button>
            <button onclick="addMission()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 w-full rounded mt-2">Add Mission</button>
            <button id="addWaypointBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 w-full rounded mt-2">Add Waypoint</button>
            <button onclick="clearAllData()" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-4 w-full rounded mt-4">Clear All Data</button>
        </div>
        <div id="summary">
            <h2 class="text-lg font-semibold mb-2">Mission Summary</h2>
            <p class="text-gray-200">Total Distance: {{.Distance}} km</p>
            <p class="text-gray-200">Duration: {{.Duration}}</p>
        </div>
        <div id="geofence-alert" class="hidden bg-red-600 text-white p-2 mt-4 rounded">
            <strong>Alert:</strong> Waypoint outside geofenced area!
        </div>
    </div>
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([24.7136, 46.6753], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var waypoints = [];
        var polyline;
        var ws;
        var paused = false;
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polygon: true,
                polyline: false,
                rectangle: false,
                circle: false,
                marker: false,
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            drawnItems.addLayer(layer);

            // Extract vertices from the drawn polygon
            if (event.layerType === 'polygon') {
                const vertices = layer.getLatLngs()[0].map(latlng => [latlng.lat, latlng.lng]);
                if (vertices.length > 0) {
                    layer.options.vertices = vertices; // Attach vertices to layer for saving later
                } else {
                    alert("Cannot add an empty geofence.");
                }
            }
        });

        document.getElementById('saveGeofenceBtn').addEventListener('click', function() {
            drawnItems.eachLayer(function(layer) {
                if (layer.options.vertices) {
                    addGeofence(layer.options.vertices);
                }
            });
        });

        document.getElementById('addWaypointBtn').addEventListener('click', function() {
            map.once('click', function(e) {
                const latitude = e.latlng.lat;
                const longitude = e.latlng.lng;
                const missionID = document.getElementById("mission-select").value;

                const waypointData = {
                    mission_id: parseInt(missionID),
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: new Date().toISOString()
                };

                fetch('/add_waypoint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(waypointData)
                }).then(response => {
                    if (response.ok) {
                        alert("Waypoint added successfully!");
                    } else {
                        alert("Failed to add waypoint.");
                    }
                });
            });
        });


	function loadMissions() {
    fetch('/missions')
        .then(response => response.json())
        .then(data => {
            if (!Array.isArray(data)) {
                console.error("Missions data is not an array:", data);
                return;
            }
            const missionSelect = document.getElementById("mission-select");
            missionSelect.innerHTML = "";
            data.forEach(mission => {
                let option = document.createElement("option");
                option.value = mission.id;
                option.textContent = `${mission.name} (${mission.status})`;
                missionSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching missions:', error);
        });
}


        function clearAllData() {
            fetch('/clear_all', { method: 'POST' }).then(response => {
                if (response.ok) {
                    alert("All data cleared successfully!");
                } else {
                    alert("Failed to clear data.");
                }
            });
        }

	function addMission() {
        const missionName = prompt("Enter the mission name:");
        if (missionName) {
            const missionData = {
                name: missionName
            };

            fetch('/add_mission', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(missionData)
            })
            .then(response => {
                if (response.status === 201) {
                    alert("Mission added successfully!");
                    loadMissions(); // Reload mission list after adding a new mission
                } else {
                    alert("Failed to add mission.");
                }
            })
            .catch(error => {
                console.error("Error adding mission:", error);
            });
        }
    }

        // Load all missions on page load
        loadMissions();
    </script>
</body>
</html>
